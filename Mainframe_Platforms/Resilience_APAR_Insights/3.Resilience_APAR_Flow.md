# 3. Resilience APAR Insights Flow

üö® Make sure you have completed the _Operations Insights_ lab - we will re-use some of the agents created in that lab üö®

--> [Click here to go back](../Operation_Insights/2.Operational_Agent_Flow.md)


---

## Overview

This guide walks you through creating a **NO CODE specialized IT Operations agent Resilience Apar Insights** in **Watsonx Orchestrate** that can:

1. **List APAR-level defect information** from IBM Z OS
2. **Summarize** critical updates and their impact
3. **Create a ServiceNow incident** for an APAR ID
4. **Trigger an Ansible playbook** to fix the defect

All actions are powered by *MCP (Model Context Protocol) tools* hosted as secure API endpoints and pre added agents

Check out the flow we will be going through below:

   ![resilience flow](images/resilience_flow.png)

> Prerequisites
>
> - Complete the re-requisites sent before the event ‚Üí [Setup and Configuration](https://github.com/aishwarya-hariharan/ibm-agentic-ai-for-itops/blob/main/pre-requisties/Hands%20on%20Lab%20Pre-Requisites%20-%20Set%20Up%20%26%20Configuration.md)
> 
> - Complete the Operations Insights Lab, so that some of the agents can be reused here

---

### ‚ÑπÔ∏è Before we start - What is MCP?!

MCP (Model Context Protocol) is like a USB-C for AI: it provides a universal interface for connecting AI applications to external systems such as:

- Databases (e.g., Postgres, SQL)
- Content repositories (e.g., Google Drive, GitHub)
- Business tools (e.g., Slack, Notion)
- Development environments (e.g., IDEs, CI/CD pipelines)

Instead of building custom integrations for each data source, developers can use MCP to expose their systems via MCP servers, and AI applications (called MCP clients) can connect to these servers to retrieve data or perform actions.

MCP consists of three main components

> **MCP Servers**
>
> - Expose data, tools, or workflows to AI clients.
> - Can be built using SDKs in languages like Python, Java, C#, etc.
> - Examples: GitHub, Slack, Docker, web search engines.
>   
> **MCP Clients**
> 
> - AI applications that send structured requests to MCP servers.
> - Handle sessions, parse responses, and manage context.
> - Examples: Claude.ai, IBM BeeAI, Microsoft Copilot Studio.
>   
> **MCP Hosts**
> 
> - Environments that manage multiple clients and coordinate interactions.

### üìç [Learn more about MCP from Anthropic](https://www.anthropic.com/news/model-context-protocol)

---

### Table of Contents

- [Step 0 ‚Äì Reviewing APARs in Concert for Z](#step-0---reviewing-apars-in-concert-for-z)
- [Step 1 - Create a New Agent in Orchestrate UI](#step-1--create-a-new-agent-in-orchestrate-ui)
- [Step 2 - Import MCP Tools](#step-2--import-mcp-tools)
- [Step 3 - Add the Pre-Deployed ServiceNow & Ansible Agents](#step-3---add-the-pre-deployed-servicenow--ansible-agents)
- [Step 4 - Add the Instructions to the New Agent](#step-4---add-the-instructions-to-the-new-agent)
- [Step 5 - Test the Agent](#step-5-test-the-agent)

---

# Step 0 - Reviewing APARs in Concert for Z 

## What are APARs? üëÄ

Authorized Program Analysis Reports (APARs) are problem reports for issues discovered in z/OS and the various mainframe subsystems like Db2 or IMS. When they are fixed, a Program Temporary Fix (PTF) is issued. This cycle of APARs and PTFs occurs on an ongoing basis.

Depending on the severity of the problem, an APAR might be marked as "Highly Pervasive" (HIPER). Also, sometimes PTF's have defects themselves. If so, this will result in the creation of another APAR which is flagged as a "PTF in Error" (PE). Both of these types of APARs deserve special attention as they reduce mainframe resilience and can potentially cause outages.

> For more information on APARs and IBM Concert for Z, kindly refer this - [View the file](./Resilience_APAR_Insights_guide.md)

---

# Step 1 ‚Äî Create a New Agent in Orchestrate UI

1. Click on `Launch Watsonx Orchestrate` from IBM cloud.

   ![env_details](images/orchestrate_launch_page.png)
   
2. After that you will land on the WxO homepage

      ![wxo_homepage](images/wxo-homepage.png)
   
3. Click on the manage agents tab from the bottom right corner
   
   ![wxo_homepage](images/wxo-manage-agents.png)
   
4. Then click on `create agent`
   
   ![wxo_homepage](images/create_agent.png)

5. Add Agent Name as ```Resilience_Agent``` and Agent Description as:

```bash
You are a specialized IT Operations agent for giving out details about IBM Z OS like details regarding APAR level defect information.
```

![wxo_homepage](images/agent_name2.png)

![wxo_homepage](images/agent_desrcription2.png) 

6. Click on `Create`

7. After that you will land on the homepage of your new agent created where you can modify your agent and add extra details

   ![wxo_homepage](images/agent_home_page2.png)

---

<p align="center"> Time to bring in the tools and agents our system will use üß∞ </p>

---

# Step 2 ‚Äî Import MCP Tools

> Now we will add some tools from our MCP servers.

- Scroll down to reach the tools section and select `Add tool`

![wxo_homepage](images/Add_tool2.png)

- Then select `add from file or mcp server`

![wxo_homepage](images/Add_MCP_tool2.png)

- Then click on `Add MCP server` on the top right

![wxo_homepage](images/Add_MCP_server.png)

---

### Tool 1 ‚Äî List All APAR Tool

- After proceeding forward in the next section add the server name as - ```list_all_apar_tool``` 

- In the install command enter the following:
```bash
uvx mcp-proxy https://resilience-lab-mcp-tool-1.220gu1u404kh.us-south.codeengine.appdomain.cloud/sse
```
if the above MCP server gives any error then you can use the below backup MCP server-
```bash
uvx mcp-proxy https://itops-resilience-tool-1.21rj19x2zzm7.us-south.codeengine.appdomain.cloud/sse
```

![wxo_homepage](images/Add_tool_apar1.png)

![wxo_homepage](images/Add_tool_instruction_1.png)
- Click `Connect` after filling all the details

- Once you get the success message, in the next page, switch the activation toggle for the tool to `on` position

![wxo_homepage](images/Add_toggle_1.png)

---

### Tool 2 ‚Äî Summarize APAR Update Tool

- Then again click `add MCP server` from the top and add the next tool

- Give the name as ```summarize_apar_update_tool```

- In the install command enter the following:
```bash
uvx mcp-proxy https://resilience-lab-mcp-tool-2.220gu1u404kh.us-south.codeengine.appdomain.cloud/sse
```
if the above MCP server gives any error then you can use the below backup MCP server-

```bash
uvx mcp-proxy https://itops-mcp-tool-2.21rj19x2zzm7.us-south.codeengine.appdomain.cloud/sse
```

![wxo_homepage](images/Add_tool_2_name.png)

![wxo_homepage](images/Add_tool_2_instructions.png)
- Click `Connect` after filling all the details

- Once you get the success message, in the next page, switch the activation toggle for the tool to `on` position

![wxo_homepage](images/Add_toggle_2_on.png)

---

# Step 3 - Add the Pre-Deployed ServiceNow & Ansible Agents

> Now we will add the pre-deployed agents

- Scroll down to reach the agents section and select `Add agent`
  
![wxo_homepage](images/Add_local_agents2.png)

- Then select `add from local instance`

![wxo_homepage](images/Add_from_local_instance2.png)

- Select the already deployed two agents - For this lab we only need the Ansible and ServiceNow Agents
  
![wxo_homepage](images/Add_2_agents2.png)

- Click `Add to agent`

---

<p align="center"> ü§ñ Let's set up our new agent to use these tools üõ†Ô∏è</p>

---

# Step 4 - Add the Instructions to the New Agent

Scroll to reach the `instructions` section under `Behaviour` and Add some instructions that the agent will follow as:

```bash
- When the user asks 'List the APAR level defect information' then use the 'list_apar_tool' to give a table with the list of APAR ID, Type, Risk Score, Risk Level, Hold Symptom, Held Sysmod.
  - When the user asks 'summarize the critical updates & their impact for APAR ID -' take the APAR ID number as input from the user and pass it as input to the 'summarize_apar_update_tool' to get detailed answer.
  - When the user asks 'Create a Service Now incident for APAR ID - ' take the APAR ID number as input from the user and use the 'servicenow_agent' to send the incident to Service Now.
  - When the user asks 'Run ansible playbook to fix the defect for APAR ID - ' take the APAR ID number as input from the user and use the 'ansible_agent' . this agent returns a summary that the incident has been fixed with detailed response. Tell the user that that fixes will take some time to reflect.
  - If any expected document or schema is missing, report this with actionable guidance.
- After giving output in proper format, give the user a suggestion on what can be done next. So my overall flow is listing APAR defect then summarise the defect, then create Service Now ticket and then finally Run ansible playbook to fix the defect.
```

![wxo_homepage](images/Add_agent_instructions2.png)

![wxo_homepage](images/Add_full_instruction2.png)

### üö® Ensure you change the model from the top to `llama-3-405b-instruct` üö®

![wxo_homepage](images/change_model2.png)

---

<p align="center"> ‚ú®Now let's test it out!‚ú®</p>

---

# Step 5 Test the Agent

> Once everything is done, move to the homepage of your agent and you can start asking questions

- Ask the first question as:

```bash
List the APAR level defect information
```

![wxo_homepage](images/question_apar2.png)

- Then ask the second question for getting the summary of the defect, you can ask the details for any of the APAR IDs listed in the previous output-

```bash
summarize the critical updates & their impact for APAR ID- EA67040
```

or if WxO suggests something then just agree like-

```bash
Yes for EA67040

```

![wxo_homepage](images/tool2-output2.png)


- Then ask the third question for creating a Service Now incident for a given APAR ID -

```bash
Create a Service Now incident for APAR ID - EA67040
```

or if WxO suggests something then just agree like-

```bash
Yes
```

![wxo_homepage](images/tool3-output2.png)


- This will create a Service Now incident for you and give you a url in the response that will take you to the service now website for more details
  
![wxo_homepage](images/snow_ticket_check_login.png)

![wxo_homepage](images/service-now.png)

- Then ask the fourth question for running the ansible playbook to fix the defect for the given APAR ID -

```bash
Run the ansible playbook to fix the defect for APAR ID - EA67040

```

or if WxO suggests something then just agree like-

```bash
Yes run the ansible playbook
```

![wxo_homepage](images/tool4-output2.png)

![wxo_homepage](images/tool4-output3.png)

---

<p align="center"> Congratulations on completing the Resilience Lab! üéäü•≥ </p>

---
